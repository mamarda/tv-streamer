{% extends "base.html" %}
{% block content %}
<h1>{{ stream.name }}</h1>
<img id="frame" alt="frame" style="max-width: 100%; display:block; margin-bottom:8px;" />
<audio id="audio" controls></audio>
<button id="startAudio" style="display:none;">Start audio</button>

<script>
  const frames = {{ frames|tojson }};
  const audios = {{ audios|tojson }};
  const img = document.getElementById('frame');
  const audio = document.getElementById('audio');
  const btn = document.getElementById('startAudio');

  // crude 20 fps slideshow
  let i = 0;
  function tick() {
    if (!frames.length) return;
    img.src = frames[i % frames.length];
    i++;
    setTimeout(tick, 50);
  }
  tick();

  // chain mp3 segments
  let ai = 0;
  function playNext() {
    if (!audios.length) return;
    if (ai >= audios.length) { ai = 0; }
    audio.src = audios[ai++];
    audio.play().catch(()=>{ /* ignore */ });
  }
  audio.addEventListener('ended', playNext);

  // try autoplay; if blocked, show a button
  function tryStart() {
    if (!audios.length) return;
    playNext();
    audio.play().then(() => {
      btn.style.display = 'none';
    }).catch(() => {
      btn.style.display = 'inline-block';
    });
  }
  btn.addEventListener('click', tryStart);
  tryStart();
</script>
{% endblock %}
